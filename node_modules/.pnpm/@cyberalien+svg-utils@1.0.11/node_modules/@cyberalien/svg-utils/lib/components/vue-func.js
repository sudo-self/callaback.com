import { getComponentSizeValues } from "./helpers/content/size.js";
import { stringifyFactoryIconContent } from "./helpers/content/stringify.js";
import { stringifyIconViewBox } from "../svg/viewbox/value.js";
import { createFactoryImports } from "./helpers/imports/create.js";
import { generateCSSFilesForComponent } from "./helpers/css/generate.js";
import { addSizeFunctionAsset } from "./helpers/functions/size.js";
import { stringifyFactoryPropsAsJSON } from "./helpers/props/object.js";
import { stringifyFactoryImports } from "./helpers/imports/stringify.js";
import { makeSquareViewBox } from "../svg/viewbox/square.js";
import { getUsedFactoryProps } from "./helpers/props/ts.js";
import { minifyViewBox } from "../svg/viewbox/minify.js";
import { getViewBoxRatio } from "./helpers/content/ratio.js";
import { addVueComponentTypes } from "./helpers/ts/vue.js";

/**
* Create functional Vue component code
*/
function createVueFunctionalComponent(data, options) {
	const assets = [];
	const imports = createFactoryImports();
	const dependencies = /* @__PURE__ */ new Set();
	const hasFallback = !!data.fallback;
	if (hasFallback) {
		imports.named["@iconify/css-vue"] = new Set(["Icon"]);
		dependencies.add("@iconify/css-vue");
	}
	const vueNamedImports = new Set(["defineComponent", "h"]);
	imports.named["vue"] = vueNamedImports;
	const style = generateCSSFilesForComponent(data.icon, imports, assets, options);
	const isEmbeddedCSS = options.cssMode === "embed";
	let hasFixedSize = !!options.width && !!options.height;
	const viewBox = data.viewBox;
	const hasComputedViewbox = options.square && !hasFixedSize && viewBox.width !== viewBox.height;
	const isStringViewBox = !hasFallback;
	const hasComputedRatio = hasComputedViewbox && isStringViewBox;
	if (!hasComputedViewbox && (options.width || options.height)) hasFixedSize = true;
	const componentCode = [];
	const props = {};
	if (!hasFallback) props.xmlns = "http://www.w3.org/2000/svg";
	const getViewBox = (viewBox$1) => isStringViewBox ? `'${stringifyIconViewBox(viewBox$1)}'` : JSON.stringify(minifyViewBox(viewBox$1));
	if (hasComputedViewbox) componentCode.push(`const baseViewBox = ${getViewBox(viewBox)};`, `const squareViewBox = ${getViewBox(makeSquareViewBox(viewBox))};`, `const viewBox = computed(() => props.square ? squareViewBox : baseViewBox);`);
	else componentCode.push(`const viewBox = ${getViewBox(viewBox)};`);
	const ratioValue = getViewBoxRatio(viewBox);
	if (hasComputedRatio) componentCode.push(`const ratio = computed(() => props.square ? 1 : ${ratioValue});`);
	if (hasFixedSize) {
		const sizeProps = getComponentSizeValues(options, data.viewBox);
		if (!sizeProps) throw new Error("Fixed size expected, but could not be determined");
		props.width = sizeProps.width;
		props.height = sizeProps.height;
	} else if (hasFallback) {
		props.width = {
			type: "string",
			value: "width",
			template: "width: props.width,"
		};
		props.height = {
			type: "string",
			value: "height",
			template: "height: props.height,"
		};
	} else {
		const getSizeProps = addSizeFunctionAsset(imports, assets, options);
		componentCode.push(`const size = computed(() => ${getSizeProps}(props.width, props.height, ${hasComputedRatio ? "ratio.value" : ratioValue}));`);
		vueNamedImports.add("computed");
		props.width = {
			type: "string",
			value: "width",
			template: "...size.value,"
		};
		props.height = {
			type: "string",
			value: "height",
			template: ""
		};
	}
	if (options.square) props.square = { type: "boolean" };
	props.viewBox = {
		value: "viewBox",
		template: hasComputedViewbox ? "viewBox: viewBox.value," : "viewBox,"
	};
	props[hasFallback ? "content" : "innerHTML"] = { value: stringifyFactoryIconContent(data.icon, options, isEmbeddedCSS ? style : void 0) };
	if (data.fallback) props.fallback = data.fallback;
	const types = addVueComponentTypes(data, options, assets, props);
	componentCode.push(`return () => h(${hasFallback ? "Icon" : "'svg'"}, { 
			${stringifyFactoryPropsAsJSON(props, "\n			")}
		});`);
	const usedProps = getUsedFactoryProps(props);
	const componentFunction = `const Component = defineComponent(
	(${usedProps.length ? "props" : ""}) => {
		${componentCode.join("\n		")}
	},
	{
		props: ${JSON.stringify(usedProps)}
	}
);
`;
	return {
		assets,
		content: `${stringifyFactoryImports(imports)}\n${componentFunction}\nexport default Component;\n`,
		style: isEmbeddedCSS ? void 0 : style,
		types,
		dependencies: dependencies.size ? dependencies : void 0
	};
}

export { createVueFunctionalComponent };