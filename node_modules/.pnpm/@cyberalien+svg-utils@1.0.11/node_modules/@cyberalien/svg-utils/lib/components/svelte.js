import { getComponentSizeValues } from "./helpers/content/size.js";
import { stringifyFactoryIconContent } from "./helpers/content/stringify.js";
import { stringifyIconViewBox } from "../svg/viewbox/value.js";
import { createFactoryImports } from "./helpers/imports/create.js";
import { generateCSSFilesForComponent } from "./helpers/css/generate.js";
import { addSizeFunctionAsset } from "./helpers/functions/size.js";
import { stringifyFactoryProps } from "./helpers/props/stringify.js";
import { stringifyFactoryImports } from "./helpers/imports/stringify.js";
import { makeSquareViewBox } from "../svg/viewbox/square.js";
import { getUsedFactoryProps, stringifyFactoryPropTypes } from "./helpers/props/ts.js";
import { minifyViewBox } from "../svg/viewbox/minify.js";
import { getViewBoxRatio } from "./helpers/content/ratio.js";
import { addSvelteComponentTypes } from "./helpers/ts/svelte.js";

/**
* Create Svelte component code
*/
function createSvelteComponent(data, options) {
	const useTS = options.ts ?? false;
	const assets = [];
	const imports = createFactoryImports();
	const dependencies = /* @__PURE__ */ new Set();
	const hasFallback = !!data.fallback;
	if (hasFallback) {
		imports.default["@iconify/css-svelte"] = "Icon";
		dependencies.add("@iconify/css-svelte");
	}
	const styleContent = generateCSSFilesForComponent(data.icon, imports, assets, {
		...options,
		componentType: "svelte"
	});
	let hasFixedSize = !!options.width && !!options.height;
	const viewBox = data.viewBox;
	const hasComputedViewbox = options.square && !hasFixedSize && viewBox.width !== viewBox.height;
	const isStringViewBox = !hasFallback;
	const hasComputedRatio = hasComputedViewbox && isStringViewBox;
	if (!hasComputedViewbox && (options.width || options.height)) hasFixedSize = true;
	const componentCode = [];
	const props = {};
	if (!hasFallback) props.xmlns = "http://www.w3.org/2000/svg";
	const viewBoxPropValue = `viewBox${hasComputedViewbox ? "Computed" : ""}`;
	const getViewBox = (viewBox$1) => isStringViewBox ? `'${stringifyIconViewBox(viewBox$1)}'` : JSON.stringify(minifyViewBox(viewBox$1));
	if (hasComputedViewbox) componentCode.push(`const baseViewBox = ${getViewBox(viewBox)};`, `const squareViewBox = ${getViewBox(makeSquareViewBox(viewBox))};`, `let ${viewBoxPropValue} = $derived(square ? squareViewBox : baseViewBox);`);
	else componentCode.push(`const ${viewBoxPropValue} = ${getViewBox(viewBox)};`);
	const ratioValue = getViewBoxRatio(viewBox);
	if (hasComputedRatio) componentCode.push(`let ratio = $derived(square ? 1 : ${ratioValue});`);
	if (hasFixedSize) {
		const sizeProps = getComponentSizeValues(options, data.viewBox);
		if (!sizeProps) throw new Error("Fixed size expected, but could not be determined");
		props.width = sizeProps.width;
		props.height = sizeProps.height;
	} else if (hasFallback) {
		props.width = {
			type: "string",
			value: "width",
			template: "width={width}"
		};
		props.height = {
			type: "string",
			value: "height",
			template: "height={height}"
		};
	} else {
		const getSizeProps = addSizeFunctionAsset(imports, assets, options);
		componentCode.push(`let size = $derived(${getSizeProps}(width, height, ${hasComputedRatio ? "ratio" : ratioValue}));`);
		props.width = {
			type: "string",
			value: "width",
			template: "{...size}"
		};
		props.height = {
			type: "string",
			value: "height",
			template: ""
		};
	}
	if (options.square) props.square = { type: "boolean" };
	props.viewBox = {
		value: "viewBox",
		template: `viewBox={${viewBoxPropValue}}`
	};
	componentCode.push(`const content = ${stringifyFactoryIconContent(data.icon, options)};`);
	const innerHTML = hasFallback ? "" : "{@html content}";
	props.content = {
		value: "content",
		template: hasFallback ? `content={content} fallback="${data.fallback}"` : ""
	};
	const usedProps = getUsedFactoryProps(props);
	const propsDestricturing = usedProps.length ? `{${[...usedProps, "...props"].join(", ")}}` : "props";
	componentCode.unshift(`let ${propsDestricturing}${useTS ? ": Props" : ""} = $props();\n`);
	if (useTS) componentCode.unshift(`interface Props {\n${stringifyFactoryPropTypes(props)}\n};\n`);
	const tag = hasFallback ? "Icon" : "svg";
	const template = `<${tag} ${stringifyFactoryProps(props, "{prop}={{value}}")} {...props}>${innerHTML}</${tag}>`;
	let content = `<script${useTS ? " lang=\"ts\"" : ""}>
${stringifyFactoryImports(imports)}
${componentCode.join("\n")}
<\/script>
${template}
`;
	const style = options.cssMode === "prop" ? styleContent : void 0;
	if (styleContent && !style) content += `<style>\n${styleContent}\n</style>\n`;
	const types = addSvelteComponentTypes(data, options, assets, props);
	return {
		assets,
		content,
		style,
		types,
		dependencies: dependencies.size ? dependencies : void 0
	};
}

export { createSvelteComponent };