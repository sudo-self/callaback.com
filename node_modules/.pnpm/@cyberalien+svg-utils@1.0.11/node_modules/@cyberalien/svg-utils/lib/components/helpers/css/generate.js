import { stringifyCSSKeyframes, stringifyCSSSelector } from "../../../css/stringify.js";
import { generateCSSDefaultImportName } from "./name.js";
import { getGeneratedCSSFilename } from "../filenames/css.js";

/**
* Generate CSS files for component
*
* Adds imports to imports object, adds assets
*/
function generateCSSFilesForComponent(content, imports, assets, options) {
	const { classes, keyframes } = content;
	if (!classes) return;
	const { cssMode, componentType } = options;
	const isComponent = cssMode === "embed";
	const returnCSS = isComponent || cssMode === "prop";
	const isModule = cssMode === "module";
	const mergeCSS = (returnCSS || options.mergeCSS) ?? false;
	const embedAnimations = isModule && !mergeCSS;
	const classNamePrefix = isComponent && componentType === "svelte" ? ":global " : "";
	const keyframesPrefix = isComponent && componentType === "svelte" ? "-global-" : "";
	const mergedContent = [];
	for (const className in classes) {
		const baseContent = stringifyCSSSelector(`${classNamePrefix}.${className}`, classes[className]);
		let content$1 = baseContent;
		if (embedAnimations && keyframes) {
			for (const animationName in keyframes) if (baseContent.includes(animationName)) {
				const value = keyframes[animationName];
				content$1 += "\n" + (typeof value === "string" ? value : stringifyCSSKeyframes(keyframesPrefix + animationName, value));
			}
		}
		if (mergeCSS) {
			mergedContent.push(content$1);
			continue;
		}
		const filename = getGeneratedCSSFilename(className, options);
		assets.push({
			...filename,
			content: content$1
		});
		if (isModule) imports.modules[filename.import] = generateCSSDefaultImportName(className);
		else imports.css.add(filename.import);
	}
	if (!embedAnimations && keyframes) for (const animationName in keyframes) {
		const value = keyframes[animationName];
		const content$1 = typeof value === "string" ? value : stringifyCSSKeyframes(keyframesPrefix + animationName, value);
		if (mergeCSS) {
			mergedContent.push(content$1);
			continue;
		}
		const filename = getGeneratedCSSFilename(animationName, options);
		assets.push({
			...filename,
			content: content$1
		});
		if (isModule) imports.modules[filename.import] = generateCSSDefaultImportName(animationName);
		else imports.css.add(filename.import);
	}
	if (mergeCSS && mergedContent.length) {
		const content$1 = mergedContent.join("\n");
		if (typeof mergeCSS == "object") {
			assets.push({
				...mergeCSS,
				content: content$1
			});
			if (isModule) imports.modules[mergeCSS.import] = "css";
			else if (!returnCSS) imports.css.add(mergeCSS.import);
		}
		return returnCSS ? content$1 : void 0;
	}
}

export { generateCSSFilesForComponent };